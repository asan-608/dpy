<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>商品价格分析</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.4.3/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .file-upload {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .chart {
            height: 400px;
            width: 100%;
        }
        h2 {
            margin-bottom: 20px;
            color: #333;
        }
        .upload-btn {
            background: #4e79a7;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 0;
        }
        .upload-btn:hover {
            background: #3d6890;
        }
        #fileInput {
            display: none;
        }
        .stats {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 4px;
            text-align: left;
        }
        .stats p {
            margin: 5px 0;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="file-upload">
            <h2>数据文件上传</h2>
            <input type="file" id="fileInput" accept=".json">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">选择JSON文件</button>
            <div class="stats" id="statsContainer" style="display: none;">
                <p id="totalItems">总商品数：-</p>
                <p id="avgPrice">平均价格：-</p>
                <p id="priceRange">价格范围：-</p>
            </div>
        </div>
        <div class="chart-container">
            <h2>价格分布散点图</h2>
            <div id="scatterChart" class="chart"></div>
        </div>
        <div class="chart-container">
            <h2>价格区间统计</h2>
            <div id="histogramChart" class="chart"></div>
        </div>
        <div class="chart-container">
            <h2>价格箱线图</h2>
            <div id="boxplotChart" class="chart"></div>
        </div>
    </div>

    <script>
        let charts = {
            scatter: null,
            histogram: null,
            boxplot: null
        };

        // 初始化图表实例
        function initChartInstances() {
            charts.scatter = echarts.init(document.getElementById('scatterChart'));
            charts.histogram = echarts.init(document.getElementById('histogramChart'));
            charts.boxplot = echarts.init(document.getElementById('boxplotChart'));

            // 响应式调整
            window.addEventListener('resize', function() {
                Object.values(charts).forEach(chart => chart && chart.resize());
            });
        }

        // 处理文件上传
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        processAndDisplayData(data);
                    } catch (error) {
                        alert('JSON文件解析错误！');
                        console.error('Error parsing JSON:', error);
                    }
                };
                reader.readAsText(file);
            }
        });

        // 处理数据并显示图表
        function processAndDisplayData(data) {
            // 处理价格数据
            const processedData = data.map(item => ({
                name: item.name,
                price: parseFloat(item.price.replace('¥', ''))
            }));

            const prices = processedData.map(item => item.price);

            // 更新统计信息
            updateStats(prices);

            // 更新图表
            updateScatterChart(processedData);
            updateHistogramChart(prices);
            updateBoxplotChart(prices);
        }

        // 更新统计信息
        function updateStats(prices) {
            const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
            const min = Math.min(...prices);
            const max = Math.max(...prices);

            document.getElementById('statsContainer').style.display = 'block';
            document.getElementById('totalItems').textContent = `总商品数：${prices.length}`;
            document.getElementById('avgPrice').textContent = `平均价格：¥${avg.toFixed(2)}`;
            document.getElementById('priceRange').textContent = `价格范围：¥${min.toFixed(2)} - ¥${max.toFixed(2)}`;
        }

        // 更新散点图
        function updateScatterChart(data) {
            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        const index = params.dataIndex;
                        return `商品：${data[index].name}<br/>价格：¥${params.value[1].toFixed(2)}`;
                    }
                },
                xAxis: {
                    type: 'value',
                    name: '商品序号',
                    nameLocation: 'middle',
                    nameGap: 30
                },
                yAxis: {
                    type: 'value',
                    name: '价格 (¥)',
                    nameLocation: 'middle',
                    nameGap: 40
                },
                series: [{
                    type: 'scatter',
                    data: data.map((item, index) => [index, item.price]),
                    symbolSize: 8,
                    itemStyle: {
                        color: '#4e79a7'
                    }
                }]
            };
            charts.scatter.setOption(option);
        }

        // 更新直方图
        function updateHistogramChart(prices) {
            const rangeSize = 20;
            const priceRanges = {};
            prices.forEach(price => {
                const range = Math.floor(price / rangeSize) * rangeSize;
                priceRanges[range] = (priceRanges[range] || 0) + 1;
            });

            const option = {
                tooltip: {
                    trigger: 'axis',
                    formatter: function(params) {
                        const range = params[0].name;
                        return `价格区间：¥${range}-¥${Number(range) + rangeSize}<br/>商品数量：${params[0].value}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    name: '价格区间 (¥)',
                    data: Object.keys(priceRanges).sort((a, b) => Number(a) - Number(b)),
                    nameLocation: 'middle',
                    nameGap: 30
                },
                yAxis: {
                    type: 'value',
                    name: '商品数量',
                    nameLocation: 'middle',
                    nameGap: 40
                },
                series: [{
                    type: 'bar',
                    data: Object.keys(priceRanges)
                        .sort((a, b) => Number(a) - Number(b))
                        .map(key => priceRanges[key]),
                    itemStyle: {
                        color: '#f28e2c'
                    }
                }]
            };
            charts.histogram.setOption(option);
        }

        // 更新箱线图
        function updateBoxplotChart(prices) {
            const sortedPrices = prices.sort((a, b) => a - b);
            const q1 = sortedPrices[Math.floor(sortedPrices.length * 0.25)];
            const median = sortedPrices[Math.floor(sortedPrices.length * 0.5)];
            const q3 = sortedPrices[Math.floor(sortedPrices.length * 0.75)];
            const iqr = q3 - q1;
            const min = Math.max(q1 - 1.5 * iqr, sortedPrices[0]);
            const max = Math.min(q3 + 1.5 * iqr, sortedPrices[sortedPrices.length - 1]);

            const option = {
                tooltip: {
                    trigger: 'item',
                    formatter: function(params) {
                        if (params.componentSubType === 'boxplot') {
                            return `最大值：¥${params.data[5]?.toFixed(2)}<br/>` +
                                   `上四分位：¥${params.data[4]?.toFixed(2)}<br/>` +
                                   `中位数：¥${params.data[3]?.toFixed(2)}<br/>` +
                                   `下四分位：¥${params.data[2]?.toFixed(2)}<br/>` +
                                   `最小值：¥${params.data[1]?.toFixed(2)}`;
                        }
                        return `异常值：¥${params.value?.toFixed(2)}`;
                    }
                },
                xAxis: {
                    type: 'category',
                    data: ['商品价格']
                },
                yAxis: {
                    type: 'value',
                    name: '价格 (¥)',
                    nameLocation: 'middle',
                    nameGap: 40
                },
                series: [{
                    type: 'boxplot',
                    data: [[min, q1, median, q3, max]],
                    itemStyle: {
                        color: '#e15759'
                    }
                }]
            };
            charts.boxplot.setOption(option);
        }

        // 页面加载完成后初始化图表实例
        document.addEventListener('DOMContentLoaded', initChartInstances);
    </script>
</body>
</html>